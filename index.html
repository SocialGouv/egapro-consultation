<!DOCTYPE html>
<html lang="fr">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
<title>L'index d'égalité dans les entreprises - Ministère du Travail</title>
<link rel="stylesheet" href="assets/css/consultation.css">
<script
  src="assets/js/sentry.min.js"
  integrity="sha384-ir4+BihBClNpjZk3UKgHTr0cwRhujAjy/M5VEGvcOzjhM1Db79GAg9xLxYn4uVK4"
  crossorigin="anonymous"
></script>
<script>
  if (typeof Sentry !== "undefined") {
    Sentry.init({
      dsn: 'https://c98522783c284ae1ada779bc05a57a96@sentry.fabrique.social.gouv.fr/51',
      release: '{{ site.version }}'
    })
  }
</script>

<header>
  <div class=content-wrapper>
    <a href="https://travail-emploi.gouv.fr/" target="_blank">
      <img src="assets/img/marianne-header.png" alt="Ministère du travail, de l'emploi et de l'insertion. Liberté, égalité, fraternité">
    </a>
    <a href="#!">
      <img src="assets/img/logo.png" alt="Index Égalité Femme/Homme">
    </a>
    <hgroup>
    <h1><a href="#!">Index Égalité Professionnelle</a></h1>
    </hgroup>
    <p hidden>
      <a>Comment l'index est-il calculé ?</a>
    </p>
  </div>
</header>

<main>
  <article id="search">
    <form action="#!/search" class="row">
      <h1>Rechercher l'index de l'égalité professionnelle d'une entreprise de 1000 salariés ou plus</h1>
      <input type="search" name="q" value="<%= state.filters.get('q') %>" placeholder="Saisissez le nom ou le SIREN d'une entreprise" autofocus>
      <button class="button primary">Rechercher</button>
    </form>
  </article>

  <% if (state.current_page == 'home') { %>
  <form action="#!/" id=filter-index>
    <h1>Index moyen par critères</h1>

    <fieldset>
      <select name="region" title="Filtrer par région" onchange="submitForm(this.form)">
        <option value="">Région</option>
        <% Object.entries(state.config.REGIONS).sort((a, b) => a[1].localeCompare(b[1])).map(([code, name]) => { %>
        <option value="<%= code %>" selected="<%= state.filters.get('region') == code %>">
          <%= state.config.REGIONS[code] %>
        </option>
        <% }) %>
      </select>

      <select name="departement" title="Filtrer par département" onchange="submitForm(this.form)">
        <option value="">Département</option>
        <% Object.entries(state.config.DEPARTEMENTS)
          .sort((a, b) => a[1].localeCompare(b[1]))
          .filter(([code, name]) => state.filters.get('region')
            ? state.config.REGIONS_TO_DEPARTEMENTS[state.filters.get('region')].includes(code)
            : true)
          .map(([code, name]) => { %>
          <option value="<%= code %>" selected="<%= state.filters.get('departement') == code %>">
            <%= state.config.DEPARTEMENTS[code] %>
          </option>
        <% }) %>
      </select>

      <select name="section_naf" title="Filtrer par code NAF" onchange="submitForm(this.form)">
        <option value="">Code NAF</option>
        <% for(code in state.config.SECTIONS_NAF){ %>
          <option value="<%= code %>" selected="<%= state.filters.get('section_naf') == code %>">
            <%= state.config.SECTIONS_NAF[code] %>
          </option>
        <% } %>
      </select>
    </fieldset>
  </form>

  <article id="average">
    <p>
      <span><%= Math.round(state.stats.avg) %></span> Index moyen <%= state.current_year %>
    </p>
    <a href="/search" class="button primary">Voir la liste</a>
  </article>

  <article id="download">
    <p>
      Vous souhaitez consulter les données de toutes les entreprises ?
      <br>
      Téléchargez le fichier recensant toutes les déclarations <span id="csv-date">
        <% if (state.csv_update) { %>
          au <%= state.csv_update %>
        <% } else { %>
          actuelles
        <% } %>
        <span> au format tableur (.csv) :
    </p>
    <a class="button" href="/index-egalite-fh.csv" download>⤓ Télécharger</a>
  </article>

  <% } %>

  <% if (state.current_page == 'search') { %>
  <article name="search">
    <div class="content-wrapper">
      <% if(state.results.data.length > 0) { %>
      <h1>
        <%= state.results.data.length %> résultat<% if(state.results.data.length > 1) { %>s<% } %>
        <% if(state.results.count > state.results.data.length) { %>
          sur <%= state.results.count %> existant
        <% } %>
      </h1>
      <% } else { %>
        <p id=no-result>Aucun résultat ne correspond à votre recherche. Veuillez adapter votre recherche.</p>
      <% } %>

      <% state.results.data.forEach((record) => { %>

      <article class=result>
        <header>
          <h1><%= record.entreprise.raison_sociale %></h1>
          <p>SIREN : <%= record.entreprise.siren %></p>
          <p class=department>Département <%= state.config.DEPARETMENTS %></p>
        </header>
        <section>
          <p>
            <span>
              <% if(record.entreprise.effectif.tranche && record.entreprise.effectif.tranche.includes('1000')) { %>
                Plus de 1000
              <% } else { %>
                  251 à 1000
              <% } %>
            </span>
            salariés
          </p>
        </section>
        <% Object.entries(record.notes).sort().reverse().forEach((declaration) => { %>
          <section>
            <p>
              <span><%= declaration[1] %></span>
              Index <%= Number(declaration[0]) + 1 %>
            </p>
          </section>
        <% }) %>
        <% if(record.entreprise.ues) { %>
          <details>
            <summary>Voir les entreprises composant l'UES</summary>
            <ol>
              <% record.entreprise.ues.entreprises.forEach(ues => { %>
                <li><%= ues.raison_sociale %> (Siren : <%= ues.siren %>)</li>
              <% }) %>
            </ol>
          </details>
        <% } %>
      </article>
      <% }) %>
      <% if(state.results.count > state.results.data.length) { %>
        <footer>
          <button onclick="moreResults()" class="button">Voir les résultats suivants…</button>
        </footer>
      <% } %>
    </div>
  </article>
  <% } %>

  <% if(state.current_page == '404') { %>
  <article name="404">
    La page demandée n'existe pas
  </article>
  <% } %>
</main>

<footer>
  <div class="content-wrapper">
    <section>
      <header>
        <a href="https://travail-emploi.gouv.fr/" target="_blank">
          <img src="assets/img/marianne-footer.png" alt="Ministère du travail, de l'emploi et de l'insertion. Liberté, égalité, fraternité">
        </a>
      </header>
      <aside>
        <p>
          Porté par la loi « Pour la liberté de choisir son avenir professionel » du 5 septembre 2018, l'Index d'égalité professionnelle a été conçu pour faire progresser au sein des entreprises l'égalité salariale entre les femmes et les hommes.
        </p>
      </aside>
    </section>
    <nav>
      <a href="https://voxusagers.numerique.gouv.fr/Demarches/2240?&amp;view-mode=formulaire-avis&amp;nd_mode=en-ligne-enti%C3%A8rement&amp;nd_source=button&amp;key=73366ddb13d498f4c77d01c2983bab48" target="_blank" rel="noopener noreferrer">Donnez-nous votre avis</a>
      <a href="https://github.com/SocialGouv/egapro-consultation/tree/{{ site.version }}" target="_blank" rel="noopener noreferrer">Contribuez sur Github</a>
      <a href="mailto:index@travail.gouv.fr?subject=À propos du site de consultation">Contact</a>
    </nav>
  </div>
</footer>

<script src="assets/js/page.js"></script>
<script src="assets/js/ejs.js"></script>
<script src="assets/js/utils.js"></script>
<script>
  const config = {
    apiUrl: 'https://dev.egapro.fabrique.social.gouv.fr/api'
  }

  function api(method, uri) {
    return request(method, `${config.apiUrl}${uri}`)
  }

  ///////////
  /* State */
  ///////////

  const state = {
    csv_update: undefined,
    current_year: (new Date()).getFullYear() - 1,
    stats: { count: 0, avg: 0, min: 0, max: 0 },
    results: { count: 0, data: [] },
    config: {},
    filters: {},
  }

  async function init() {
    const responseCsv = await request('head', "/index-egalite-fh.csv")
    const lastModified = new Date(responseCsv.headers.get('last-modified'))
    state.csv_update = lastModified.toLocaleDateString()
    const responseConfig = await api('get', "/config")
    state.config = responseConfig.data

    // Start page router
    page({ hashbang: true })
  }

  ////////////////
  /* Templating */
  ////////////////

  const template = document.body.innerHTML
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&amp;/g, '&')

  function render() {
    // First rendering, avoid first load flash glitch
    if(!document.body.classList.contains('ready')) document.body.classList.add('ready')

    document.body.innerHTML = ejs.render(template, state)

    // Handle form submition to redirect to hash
    Array.from(document.querySelectorAll('form')).forEach((form) => {
      form.addEventListener('submit', (event) => {
        event.preventDefault()
        submitForm(form)
      })
    })

    // Boolean attributes cannot be propertly rendered with this template engine
    // They are therefore rendered as `selected="true"` and should be cleaned up
    document.querySelectorAll('[selected]').forEach(node => {
      const attr = node.getAttribute('selected')
      if(attr === 'false') {
        node.selected = false
        node.removeAttribute('selected')
      }
      else if(attr === 'true') {
        node.selected = true
      }
    })
  }

  function submitForm(form) {
    const queryParams = new URLSearchParams(new FormData(form))
    const pathname = new URL(form.action).hash
    page(`${pathname}?${queryParams}`)
  }

  function queryFilters(query) {
    const paramsWithValue = new URLSearchParams(Array.from(query).filter(pair => pair[1]))
    return Array.from(paramsWithValue.entries()).reduce((filters, [key, value]) => {
        filters[key] = value
        return filters
      }, {})
  }


  /////////////////
  /* Controllers */
  /////////////////

  // Enable query params for router. This must remain before specific routes.
  page('*', (req, next) => {
    req.query = new URLSearchParams(req.path.split('?')[1])
    req.filters = new URLSearchParams(Array.from(req.query).filter(pair => pair[1]))
    next()
  })

  page('/', async (req) => {
    const response = await api('get', `/search?${req.filters}`)
    state.stats = response.data
    state.filters = req.filters
    state.current_page = 'home'
    render()
  })

  page('/search', async (req) => {
    const filters = req.filters
    const page = Number(filters.page)

    // Pagination
    if(page) {
      filters.set('offset', page * 10)
      filters.delete('page')
    }

    const response = await api('GET', `/search?${filters}`)

    // Update state
    Object.assign(state, {
      current_page: 'search',
      stats: response.data,
      results: {
        count: response.data.count,
        data: state.results.data.concat(response.data.data)
      },
      filters
    })
    render()
  })

  page('*', () => {
    state.current_page = '404'
    render()
  })

  function moreResults() {
    const queryParams = new URLSearchParams(page.current.split('?')[1])
    queryParams.set('page', Number(queryParams.get('page') || 1) + 1)
    page.redirect(`/search?${queryParams}`)
  }

  init()
</script>

</html>
